<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Diagnostics - EyesOn</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #1b2636; color: #e0e0e0; }
    .card { background-color: #253346; border-color: #2c3e50; color: #fff; }
    code, pre { color: #e0e0e0; }
    .badge-ok { background: #198754; }
    .badge-bad { background: #dc3545; }
    .muted { color: #9ca3af; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">API Diagnostics</h3>
        <div class="muted">Provider endpoint availability + simulator state</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light" href="/index.html">Dashboard</a>
        <a class="btn btn-outline-light" href="/swagger.html">Swagger</a>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Username</label>
            <input id="username" class="form-control" value="admin" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Password</label>
            <input id="password" type="password" class="form-control" value="admin" />
          </div>
          <div class="col-md-6 d-flex gap-2">
            <button id="loginBtn" class="btn btn-primary">Login (store token)</button>
            <button id="refreshBtn" class="btn btn-success">Refresh diagnostics</button>
            <button id="clearBtn" class="btn btn-outline-warning">Clear token</button>
          </div>
        </div>
        <div id="statusLine" class="mt-3 muted"></div>
        <div id="errorLine" class="mt-2 text-danger" style="display:none;"></div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>Endpoint summary</div>
        <div class="muted" id="serverTime"></div>
      </div>
      <div class="card-body" id="summary"></div>
    </div>

    <div class="card">
      <div class="card-header">Raw JSON</div>
      <div class="card-body">
        <pre id="jsonOut" style="white-space: pre-wrap; margin: 0;"></pre>
      </div>
    </div>
  </div>

<script>
  const API = '/api/v1';

  function setError(msg) {
    const el = document.getElementById('errorLine');
    if (!msg) { el.style.display = 'none'; el.textContent = ''; return; }
    el.style.display = 'block';
    el.textContent = msg;
  }

  function token() {
    return localStorage.getItem('token');
  }

  async function login() {
    setError('');
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    const resp = await fetch(`${API}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const body = await resp.json().catch(() => ({}));
    if (!resp.ok || !body.token) {
      throw new Error(body.error || 'Login failed');
    }
    localStorage.setItem('token', body.token);
    return body;
  }

  function badge(ok) {
    const cls = ok ? 'badge badge-ok' : 'badge badge-bad';
    const txt = ok ? 'OK' : 'MISSING';
    return `<span class="${cls}">${txt}</span>`;
  }

  function renderSummary(data) {
    const prov = data?.provider;
    const endpoints = prov?.endpoints || {};

    const rows = Object.entries(endpoints).map(([name, r]) => {
      const ok = !!r.ok;
      const status = r.status_code ?? '';
      const ms = r.duration_ms ?? '';
      return `
        <tr>
          <td><code>${name}</code></td>
          <td>${badge(ok)}</td>
          <td><code>${status}</code></td>
          <td><code>${ms}</code></td>
          <td class="text-truncate" style="max-width: 480px;"><small class="muted">${(r.url || '').replace(/</g,'&lt;')}</small></td>
        </tr>
      `;
    }).join('');

    const sim = prov?.simulator;
    const simLine = sim
      ? `Simulator: enabled=<code>${sim.enabled}</code>, sim_count=<code>${sim.sim_count}</code>, actual_count=<code>${sim.actual_count}</code> (<a href="${prov.base_url}/web" target="_blank">open</a>)`
      : `Simulator: <span class="muted">not detected</span>`;

    document.getElementById('summary').innerHTML = `
      <div class="mb-2">Provider base URL: <code>${prov?.base_url || ''}</code></div>
      <div class="mb-3">${simLine}</div>
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead><tr><th>Endpoint</th><th>Exists</th><th>Status</th><th>ms</th><th>URL</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="muted">
        Tip: если <code>updateProvisioningData</code> = MISSING, а <code>updateSIMStatusChange</code> = OK — это legacy simulator режим.
      </div>
    `;
  }

  async function refresh() {
    setError('');
    const t = token();
    if (!t) throw new Error('No token in localStorage. Login first.');

    const resp = await fetch(`${API}/api-status/diagnostics`, {
      headers: { 'Authorization': `Bearer ${t}` }
    });
    const body = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(body.error || 'Diagnostics failed');

    document.getElementById('jsonOut').textContent = JSON.stringify(body, null, 2);
    document.getElementById('serverTime').textContent = body.server_time || '';
    renderSummary(body);
    return body;
  }

  function updateStatusLine() {
    const t = token();
    document.getElementById('statusLine').textContent = t ? 'Token is present in localStorage (key: token).' : 'No token in localStorage.';
  }

  document.getElementById('loginBtn').addEventListener('click', async () => {
    try {
      await login();
      updateStatusLine();
      await refresh();
    } catch (e) {
      setError(e.message || String(e));
    }
  });

  document.getElementById('refreshBtn').addEventListener('click', async () => {
    try {
      await refresh();
    } catch (e) {
      setError(e.message || String(e));
    }
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    updateStatusLine();
    document.getElementById('jsonOut').textContent = '';
    document.getElementById('summary').textContent = '';
    document.getElementById('serverTime').textContent = '';
    setError('');
  });

  // Initial load
  updateStatusLine();
  // Auto-refresh if token already exists
  if (token()) {
    refresh().catch(() => {});
  }
</script>
</body>
</html>
